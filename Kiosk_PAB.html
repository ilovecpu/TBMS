<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pick A Bap - Clock In/Out</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#1a237e;--success:#43a047;--danger:#e53935;--bg:#1b5e20;--card:#fff;--text:#333;--text-light:#666;--border:#ddd}
body{font-family:'Noto Sans KR',sans-serif;background:linear-gradient(135deg,#1b5e20 0%,#2e7d32 100%);min-height:100vh;display:flex;flex-direction:column;align-items:center;color:var(--text);overflow-x:hidden;-webkit-user-select:none;user-select:none}

/* Toast */
.toast-box{position:fixed;top:16px;right:16px;z-index:1000}
.toast{padding:14px 24px;border-radius:12px;color:#fff;font-size:15px;font-weight:500;display:flex;align-items:center;gap:10px;animation:slideIn .3s;box-shadow:0 4px 20px rgba(0,0,0,.3);margin-bottom:8px}
.toast.success{background:var(--success)}.toast.error{background:var(--danger)}.toast.info{background:var(--primary)}
@keyframes slideIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}

/* Header */
.header{text-align:center;color:#fff;padding:24px 20px 16px;width:100%}
.header h1{font-size:26px;display:flex;align-items:center;justify-content:center;gap:12px;text-shadow:0 2px 8px rgba(0,0,0,.2)}
.header p{font-size:15px;opacity:.85;margin-top:6px}

/* Main Card */
.main-card{background:#fff;border-radius:20px;padding:36px;width:calc(100% - 40px);max-width:480px;box-shadow:0 20px 60px rgba(0,0,0,.25);margin:8px 0 20px;min-height:400px;display:flex;flex-direction:column;align-items:center;justify-content:center}

/* Clock */
.clock{font-size:56px;font-weight:700;color:var(--primary);text-align:center;font-variant-numeric:tabular-nums;letter-spacing:2px}
.date{text-align:center;color:var(--text-light);font-size:15px;margin-top:4px;margin-bottom:28px}

/* Staff Grid */
.staff-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:12px;width:100%;max-height:360px;overflow-y:auto;padding:4px}
.staff-btn{padding:18px 8px;background:#f5f7fa;border-radius:14px;text-align:center;cursor:pointer;transition:all .2s;border:2px solid transparent}
.staff-btn:hover,.staff-btn:active{border-color:var(--primary);background:#e8eaf6;transform:scale(1.03)}
.staff-btn .avatar{width:52px;height:52px;background:var(--primary);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-weight:700;font-size:20px}
.staff-btn .name{font-size:13px;font-weight:600;line-height:1.3;word-break:keep-all}

/* Password */
.pw-section{text-align:center;width:100%}
.pw-section .avatar-lg{width:64px;height:64px;background:var(--primary);color:#fff;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:26px;font-weight:700;margin-bottom:12px}
.pw-section h3{font-size:20px;margin-bottom:20px}
.pw-input{width:100%;padding:16px;border:2px solid var(--border);border-radius:12px;font-size:28px;text-align:center;letter-spacing:12px;margin-bottom:16px;transition:border-color .2s}
.pw-input:focus{outline:none;border-color:var(--primary)}

/* Buttons */
.btn{padding:14px 28px;border-radius:12px;font-size:16px;font-weight:600;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:10px;transition:all .2s;width:100%}
.btn:active{transform:scale(.97)}
.btn-primary{background:var(--primary);color:#fff}
.btn-success{background:var(--success);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-outline{background:transparent;border:2px solid var(--border);color:var(--text);width:auto;padding:10px 20px;font-size:14px}

/* Action Buttons */
.action-btns{display:flex;flex-direction:column;gap:14px;width:100%;margin-top:20px}
.action-btn{padding:24px;border-radius:14px;font-size:22px;font-weight:700;color:#fff;cursor:pointer;text-align:center;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:12px;border:none}
.action-btn:active{transform:scale(.97)}
.action-btn.in{background:linear-gradient(135deg,#43a047,#2e7d32)}
.action-btn.out{background:linear-gradient(135deg,#e53935,#c62828)}

/* Result */
.result{text-align:center;width:100%}
.result .icon{font-size:72px;margin-bottom:16px}
.result .msg{font-size:22px;font-weight:700;margin-bottom:8px}
.result .time{font-size:36px;color:var(--primary);font-weight:700}
.result .who{margin-top:12px;color:var(--text-light);font-size:16px}

/* Status bar */
.status-bar{color:rgba(255,255,255,.6);font-size:12px;padding:8px;display:flex;align-items:center;gap:6px;position:fixed;bottom:8px}
.status-dot{width:8px;height:8px;border-radius:50%;background:#43a047}
.status-dot.off{background:#fb8c00}

/* Loading */
.loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;color:#fff;font-size:16px}
.loading-overlay.hidden{display:none}
.spinner{width:44px;height:44px;border:4px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Today's record */
.today-records{width:100%;margin-top:16px;background:#f8faf8;border-radius:10px;padding:12px;max-height:120px;overflow-y:auto}
.today-records h4{font-size:12px;color:var(--text-light);margin-bottom:8px}
.today-records .rec{font-size:13px;display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee}
.today-records .rec:last-child{border:none}

@media(max-width:400px){
  .clock{font-size:42px}
  .staff-grid{grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
  .staff-btn{padding:14px 6px}
  .staff-btn .avatar{width:44px;height:44px;font-size:18px}
  .main-card{padding:24px}
}
</style>
</head>
<body>

<div class="loading-overlay" id="loading"><div class="spinner"></div><div id="loadingText">Loading...</div></div>
<div class="toast-box" id="toastBox"></div>

<div class="header">
  <h1><i class="fas fa-bowl-food"></i> Pick A Bap</h1>
  <p>Farnborough - Staff Clock In/Out</p>
</div>

<div class="main-card" id="mainCard"></div>

<div class="status-bar"><span class="status-dot" id="statusDot"></span><span id="statusText">Connecting...</span></div>

<script>
// ==================== CONFIG ====================
const STORE_ID = 'PAB';
const STORE_NAME = 'Pick A Bap';
const API_URL = 'https://script.google.com/macros/s/AKfycby4-TUEUu3VUpKNIGXH4HlFzbvSUgaP18QfDN4RKzrzJ17OKqO8Uygh9o6JmqfhelGI/exec';

// ==================== UTILS ====================
const $=id=>document.getElementById(id);
function toast(msg,type='info'){const t=document.createElement('div');t.className='toast '+type;t.innerHTML='<i class="fas fa-'+(type==='error'?'exclamation-circle':type==='success'?'check-circle':'info-circle')+'"></i>'+msg;$('toastBox').appendChild(t);setTimeout(()=>t.remove(),3000);}
function showLoad(t){$('loadingText').textContent=t;$('loading').classList.remove('hidden');}
function hideLoad(){$('loading').classList.add('hidden');}
function genId(){return 'a_'+Date.now()+'_'+Math.random().toString(36).substr(2,5);}
function fmtTime(d){return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');}

// ==================== API ====================
async function apiGet(action){
  try{const r=await fetch(API_URL+'?action='+action,{redirect:'follow'});return await r.json();}
  catch(e){console.error(e);return null;}
}
async function apiPost(data){
  try{const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(data),redirect:'follow'});return await r.json();}
  catch(e){console.error(e);return null;}
}

// ==================== DATA ====================
let staff=[];
let attendance=[];
let clockTimer=null;

async function loadData(){
  showLoad('Loading staff data...');
  const result=await apiGet('getAll');
  if(result&&result.data&&!result.error){
    staff=(result.data.Staff||[]).filter(s=>String(s.storeId)===STORE_ID&&(s.active===true||s.active==='true'||s.active==='TRUE'));
    attendance=result.data.Attendance||[];
    $('statusDot').className='status-dot';
    $('statusText').textContent='Cloud Connected';
    hideLoad();return true;
  }
  $('statusDot').className='status-dot off';
  $('statusText').textContent='Offline';
  hideLoad();toast('Cannot connect to server','error');return false;
}

// ==================== SCREENS ====================
let currentStaff=null;

function showStaffList(){
  currentStaff=null;
  const now=new Date();
  const card=$('mainCard');
  card.innerHTML=`
    <div class="clock" id="clock">${now.toLocaleTimeString('en-GB')}</div>
    <div class="date">${now.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
    ${staff.length?`<div class="staff-grid">${staff.map(s=>`
      <div class="staff-btn" onclick="selectStaff('${s.id}')">
        <div class="avatar">${s.name.charAt(0).toUpperCase()}</div>
        <div class="name">${esc(s.name)}</div>
      </div>`).join('')}</div>`
      :'<p style="color:var(--text-light);text-align:center">No staff found for this store</p>'}
    <div style="margin-top:16px"><button class="btn-outline" onclick="loadData().then(()=>showStaffList())"><i class="fas fa-sync"></i> Refresh</button></div>`;
  startClock();
}

function selectStaff(id){
  currentStaff=staff.find(s=>String(s.id)===String(id));
  if(!currentStaff)return;
  const now=new Date();
  const card=$('mainCard');
  card.innerHTML=`
    <div class="clock" id="clock">${now.toLocaleTimeString('en-GB')}</div>
    <div class="date">${now.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
    <div class="pw-section">
      <div class="avatar-lg">${currentStaff.name.charAt(0).toUpperCase()}</div>
      <h3>${esc(currentStaff.name)}</h3>
      <input type="password" class="pw-input" id="pwInput" maxlength="10" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')verify()">
      <button class="btn btn-success" onclick="verify()"><i class="fas fa-check"></i> Confirm</button>
      <div style="margin-top:12px"><button class="btn-outline" onclick="showStaffList()"><i class="fas fa-arrow-left"></i> Back</button></div>
    </div>`;
  startClock();
  setTimeout(()=>$('pwInput')?.focus(),100);
}

function verify(){
  if(!currentStaff)return;
  const input=$('pwInput').value;
  if(String(currentStaff.kioskPwd)===String(input)){
    showAction();
  }else{
    toast('Wrong password','error');
    $('pwInput').value='';
    $('pwInput').focus();
  }
}

function showAction(){
  const now=new Date();
  const today=now.toISOString().split('T')[0];
  const todayAtt=attendance.filter(a=>String(a.staffId)===String(currentStaff.id)&&a.date===today);
  const openAtt=todayAtt.find(a=>a.clockIn&&!a.clockOut);
  const card=$('mainCard');
  card.innerHTML=`
    <div class="clock" id="clock">${now.toLocaleTimeString('en-GB')}</div>
    <div class="date">${now.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
    <div class="pw-section">
      <div class="avatar-lg">${currentStaff.name.charAt(0).toUpperCase()}</div>
      <h3>${esc(currentStaff.name)}</h3>
      <div class="action-btns">
        ${openAtt
          ?`<button class="action-btn out" onclick="doClockOut('${openAtt.id}')"><i class="fas fa-sign-out-alt"></i> Clock Out</button>`
          :`<button class="action-btn in" onclick="doClockIn()"><i class="fas fa-sign-in-alt"></i> Clock In</button>`}
      </div>
      ${todayAtt.length?`<div class="today-records"><h4>Today's Records</h4>${todayAtt.map(a=>`<div class="rec"><span>${a.clockIn||'-'} ‚Üí ${a.clockOut||'...'}</span></div>`).join('')}</div>`:''}
      <div style="margin-top:14px"><button class="btn-outline" onclick="showStaffList()"><i class="fas fa-arrow-left"></i> Back</button></div>
    </div>`;
  startClock();
}

async function doClockIn(){
  const now=new Date();
  const att={id:genId(),staffId:currentStaff.id,storeId:STORE_ID,date:now.toISOString().split('T')[0],clockIn:fmtTime(now),clockOut:''};
  showLoad('Recording...');
  const r=await apiPost({action:'appendRow',sheet:'Attendance',row:att});
  hideLoad();
  if(r&&!r.error){
    attendance.push(att);
    showResult('in',att.clockIn);
  }else{toast('Failed to save. Try again.','error');}
}

async function doClockOut(attId){
  const att=attendance.find(a=>String(a.id)===String(attId));
  if(!att)return;
  att.clockOut=fmtTime(new Date());
  showLoad('Recording...');
  const r=await apiPost({action:'upsert',sheet:'Attendance',row:att});
  hideLoad();
  if(r&&!r.error){
    showResult('out',att.clockOut);
  }else{toast('Failed to save. Try again.','error');}
}

function showResult(type,time){
  const card=$('mainCard');
  card.innerHTML=`
    <div class="result">
      <div class="icon">${type==='in'?'‚úÖ':'üèÅ'}</div>
      <div class="msg">${type==='in'?'Clock In Recorded!':'Clock Out Recorded!'}</div>
      <div class="time">${time}</div>
      <div class="who">${currentStaff?esc(currentStaff.name):''}</div>
    </div>`;
  toast(type==='in'?'Clock In successful!':'Clock Out successful!','success');
  setTimeout(()=>showStaffList(),3000);
}

// ==================== CLOCK ====================
function startClock(){
  if(clockTimer)clearInterval(clockTimer);
  clockTimer=setInterval(()=>{
    const el=document.querySelector('.clock');
    if(el)el.textContent=new Date().toLocaleTimeString('en-GB');
  },1000);
}

function esc(s){if(!s&&s!==0)return'';const d=document.createElement('div');d.textContent=String(s);return d.innerHTML;}

// ==================== INIT ====================
async function init(){
  const ok=await loadData();
  if(ok)showStaffList();
  else{
    $('mainCard').innerHTML='<div style="text-align:center"><p style="color:var(--danger);font-size:18px;margin-bottom:16px"><i class="fas fa-exclamation-triangle"></i> Connection Failed</p><button class="btn btn-primary" onclick="init()"><i class="fas fa-redo"></i> Retry</button></div>';
  }
}
init();
</script>
</body>
</html>
