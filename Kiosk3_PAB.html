<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pick A Bap - Mobile Time Entry</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--primary:#1b5e20;--primary-light:#4caf50;--primary-bg:#e8f5e9;--accent:#e84393;--bg:#f0faf0;--danger:#e74c3c;--success:#27ae60;--warning:#f39c12;--border:#e0e0e0;--text:#2d3436;--text-light:#636e72}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:0}
.status-bar{position:fixed;top:0;left:0;right:0;background:var(--primary);color:#fff;font-size:11px;padding:3px 12px;display:flex;align-items:center;gap:6px;z-index:999}
.status-dot{width:8px;height:8px;border-radius:50%;background:#f39c12;display:inline-block}
.status-dot.on{background:#2ecc71}
.status-dot.off{background:#e74c3c}
/* Staff Grid Login */
.login-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px;padding-top:40px;width:100%}
.login-header{text-align:center;margin-bottom:20px}
.login-header .icon{width:64px;height:64px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:28px;color:#fff}
.login-header h1{font-size:20px;font-weight:800;color:var(--primary)}
.login-header p{font-size:11px;color:var(--text-light);margin-top:2px}
.staff-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:14px;width:100%;max-width:500px;padding:4px}
.staff-btn{padding:14px 8px;background:var(--primary-bg);border-radius:16px;text-align:center;cursor:pointer;transition:all .2s;border:2.5px solid var(--primary-light)}
.staff-btn:hover,.staff-btn:active{transform:scale(1.05);filter:brightness(0.97)}
.staff-btn .avatar{width:56px;height:56px;background:var(--primary-light);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 6px;font-weight:700;font-size:22px;position:relative}
.staff-btn .avatar .status-dot{display:none;position:absolute;bottom:0;right:0;width:14px;height:14px;background:#e84393;border:2px solid #fff;border-radius:50%}
.staff-btn .name{font-size:14px;font-weight:600;line-height:1.3;word-break:keep-all}
.staff-btn.clocked-in{border-color:#e84393;background:#fff0f3}
.staff-btn.clocked-in .avatar{background:#e84393}
.staff-btn.clocked-in .status-dot{display:block}
.clock{font-size:48px;font-weight:700;color:var(--primary);text-align:center;font-variant-numeric:tabular-nums;letter-spacing:2px;margin-bottom:4px}
.date-display{text-align:center;color:var(--text-light);font-size:14px;margin-bottom:20px}
/* PIN Pad Screen */
.pin-screen{min-height:100vh;display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px;width:100%}
.pin-box{background:#fff;border-radius:16px;padding:28px 24px;width:100%;max-width:340px;box-shadow:0 8px 32px rgba(0,0,0,.12);text-align:center}
.pin-staff{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:20px}
.pin-staff .avatar{width:44px;height:44px;background:var(--primary-light);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px}
.pin-staff .name{font-size:16px;font-weight:700;color:var(--text)}
.pin-dots{display:flex;justify-content:center;gap:12px;margin-bottom:24px;min-height:24px}
.pin-dot{width:18px;height:18px;border-radius:50%;border:2px solid var(--border);background:#fff;transition:all .2s}
.pin-dot.filled{background:var(--primary);border-color:var(--primary)}
.pin-error{color:var(--danger);font-size:13px;font-weight:600;margin-bottom:12px;min-height:20px}
.pin-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:260px;margin:0 auto}
.pin-key{height:60px;border-radius:12px;background:#f5f5f5;border:2px solid var(--border);font-size:22px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:inherit;transition:all .1s;color:var(--text)}
.pin-key:active{background:var(--primary-bg);border-color:var(--primary-light);transform:scale(0.95)}
.pin-key.action{font-size:16px;background:#fff}
.pin-back-btn{margin-top:16px;padding:10px 20px;background:#f5f5f5;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-weight:600;color:#666;cursor:pointer;font-family:inherit}
/* Main Area */
.main-wrap{width:100%;padding:10px;padding-top:28px;display:flex;flex-direction:column;align-items:center;display:none}
.header{text-align:center;padding:8px 0}
.header h1{font-size:18px;font-weight:800;color:var(--primary)}
.header p{font-size:11px;color:var(--text-light);margin-top:2px}
.user-bar{display:flex;justify-content:space-between;align-items:center;width:100%;max-width:700px;padding:8px 4px;margin-bottom:4px}
.user-bar .user-info{display:flex;align-items:center;gap:8px}
.user-bar .avatar{width:36px;height:36px;background:var(--primary);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
.user-bar .name{font-weight:700;font-size:14px;color:var(--text)}
.btn-logout{padding:12px 24px;background:#f5f5f5;border:1.5px solid var(--border);border-radius:10px;font-size:15px;font-weight:700;color:#555;cursor:pointer;font-family:inherit}
.btn-logout:active{background:#eee}
.btn-save-top{padding:12px 24px;background:var(--success);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit}
.btn-save-top:active{filter:brightness(.9)}
.action-bar{display:flex;gap:10px;justify-content:center;margin:12px 0 4px;flex-wrap:wrap}
/* Calendar Card */
.card{background:#fff;border-radius:12px;padding:10px;width:100%;max-width:700px;box-shadow:0 4px 20px rgba(0,0,0,.08);margin-bottom:10px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px}
.card-header h2{font-size:15px;font-weight:700;color:var(--primary)}
.month-nav{display:flex;align-items:center;gap:6px}
.month-nav button{width:36px;height:36px;border:2px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.month-nav button:active{background:#f0f0f0}
.month-nav span{font-size:12px;font-weight:700;min-width:110px;text-align:center}
/* Time Table */
.time-table{width:100%;border-collapse:collapse;font-size:11px}
.time-table th{background:var(--primary);color:#fff;padding:6px 2px;font-size:10px;font-weight:600;text-align:center}
.time-table th.sun{background:#c0392b}
.time-table td{padding:3px 1px;border-bottom:1px solid #f0f0f0;text-align:center;vertical-align:middle}
.time-table tr.sat{background:#e3f2fd}
.time-table tr.sun{background:#fce4ec}
.time-table tr.today{background:var(--primary-bg)}
.time-table .date-cell{font-weight:700;font-size:13px;width:28px;white-space:nowrap}
.time-table .day-cell{font-size:12px;font-weight:700;width:28px}
.time-table .day-sat{color:#1565c0;font-weight:700}
.time-table .day-sun{color:#c0392b;font-weight:700}
.time-sel{padding:4px 0;border:1.5px solid var(--border);border-radius:6px;font-size:14px;font-weight:600;font-family:inherit;text-align:center;background:#fff;appearance:none;-webkit-appearance:none;width:38px}
.time-sel:focus{border-color:var(--primary);outline:none}
.time-sel.filled{border-color:var(--success);background:#f0fff0}
.time-wrap{display:inline-flex;align-items:center;gap:1px}
.time-wrap .colon{font-weight:700;font-size:14px}
.hour-cell{font-weight:700;font-size:13px;color:var(--primary);min-width:36px}
.hour-cell.zero{color:#ccc}
/* Summary */
.summary-bar{display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,var(--primary),#2e7d32);color:#fff;padding:12px 14px;border-radius:10px;margin-top:8px}
.summary-bar .total{font-size:18px;font-weight:800}
.summary-bar .label{font-size:11px;opacity:.8}
/* Buttons */
.btn{padding:10px 16px;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:5px}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:active{filter:brightness(.9)}
.btn-save{background:var(--success);color:#fff;padding:12px 20px;font-size:14px}
.btn-save:active{filter:brightness(.9)}
/* Change Request Card */
.cr-card{background:#fff;border-radius:12px;padding:14px;width:100%;max-width:700px;box-shadow:0 4px 20px rgba(0,0,0,.08);margin-bottom:10px;border-left:4px solid var(--warning)}
.cr-card h3{font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px}
.cr-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f5f5f5;font-size:12px;flex-wrap:wrap;gap:4px}
.cr-item:last-child{border-bottom:none}
.cr-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700}
.cr-badge.pending{background:#fff3cd;color:#856404;border:1px solid #ffc107}
.cr-badge.approved{background:#d4edda;color:#155724;border:1px solid #28a745}
.cr-badge.rejected{background:#f8d7da;color:#721c24;border:1px solid #dc3545}
.cr-ack-btn{padding:4px 12px;border:none;border-radius:8px;background:#28a745;color:#fff;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap}
.cr-ack-btn:active{transform:scale(.95)}
.cr-ack-btn.rej{background:#6c757d}
/* Toast */
.toast-box{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 20px;border-radius:10px;color:#fff;font-size:14px;font-weight:600;animation:toastIn .3s}
.toast.success{background:#27ae60}.toast.error{background:#e74c3c}.toast.info{background:#3498db}
@keyframes toastIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
/* Loading */
.loading{position:fixed;inset:0;background:rgba(255,255,255,.9);z-index:900;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px}
.loading.hidden{display:none}
.loading .spinner{width:40px;height:40px;border:4px solid #e0e0e0;border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.fs-overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:2000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;color:#fff;cursor:pointer;-webkit-tap-highlight-color:transparent}
.fs-overlay .fs-icon{font-size:72px;animation:fsPulse 2s infinite}
.fs-overlay h2{font-size:28px;font-weight:700}
.fs-overlay p{font-size:15px;opacity:.6}
@keyframes fsPulse{0%,100%{opacity:.7;transform:scale(1)}50%{opacity:1;transform:scale(1.1)}}
/* Mobile responsive */
@media(max-width:480px){
  .staff-grid{grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px}
  .staff-btn{padding:10px 4px}
  .staff-btn .avatar{width:42px;height:42px;font-size:16px}
  .staff-btn .name{font-size:11px}
  .pin-key{height:54px;font-size:20px}
  .time-sel{width:36px;font-size:13px;padding:3px 0}
  .card{padding:8px;border-radius:10px}
  .month-nav span{font-size:11px;min-width:100px}
  .btn{padding:8px 12px;font-size:12px}
  .btn-save{padding:10px 16px;font-size:13px}
}
@media(max-width:360px){
  .staff-grid{grid-template-columns:repeat(3,1fr)}
  .pin-key{height:48px;font-size:18px}
  .time-sel{width:32px;font-size:12px}
  .time-wrap .colon{font-size:12px}
  .hour-cell{font-size:12px;min-width:30px}
  .date-cell{font-size:12px!important}
  .day-cell{font-size:11px!important}
}
</style>
</head>
<body>
<div class="status-bar"><span class="status-dot" id="statusDot"></span><span id="statusText">Connecting...</span></div>
<div id="toastBox" class="toast-box"></div>
<div class="loading" id="loading"><div class="spinner"></div><span id="loadingText">Loading...</span></div>

<!-- STAFF GRID LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-header">
    <div class="icon"><i class="fas fa-mobile-alt"></i></div>
    <h1>Pick A Bap</h1>
    <p>Mobile Time Entry — Kiosk 3</p>
  </div>
  <div id="staffGrid" class="staff-grid"></div>
  <div style="margin-top:16px;text-align:center;font-size:10px;color:#bbb">&copy; 2026 The Bap. Programmed by DJ Kim</div>
</div>

<!-- PIN PAD SCREEN -->
<div class="pin-screen" id="pinScreen">
  <div class="pin-box">
    <div class="pin-staff">
      <div class="avatar" id="pinAvatar"></div>
      <span class="name" id="pinName"></span>
    </div>
    <div class="pin-dots" id="pinDots"></div>
    <div class="pin-error" id="pinError"></div>
    <div class="pin-pad">
      <button class="pin-key" onclick="pinPress('1')">1</button>
      <button class="pin-key" onclick="pinPress('2')">2</button>
      <button class="pin-key" onclick="pinPress('3')">3</button>
      <button class="pin-key" onclick="pinPress('4')">4</button>
      <button class="pin-key" onclick="pinPress('5')">5</button>
      <button class="pin-key" onclick="pinPress('6')">6</button>
      <button class="pin-key" onclick="pinPress('7')">7</button>
      <button class="pin-key" onclick="pinPress('8')">8</button>
      <button class="pin-key" onclick="pinPress('9')">9</button>
      <button class="pin-key action" onclick="pinClear()"><i class="fas fa-eraser"></i></button>
      <button class="pin-key" onclick="pinPress('0')">0</button>
      <button class="pin-key action" style="background:var(--primary-bg);color:var(--primary)" onclick="pinEnter()"><i class="fas fa-check"></i></button>
    </div>
    <button class="pin-back-btn" onclick="pinBack()"><i class="fas fa-arrow-left"></i> Back</button>
  </div>
</div>

<!-- MAIN AREA -->
<div class="main-wrap" id="mainWrap">
  <div class="header">
    <h1><i class="fas fa-clock"></i> Pick A Bap</h1>
    <p>Mobile Time Entry — Kiosk 3</p>
  </div>
  <div class="user-bar">
    <div class="user-info">
      <div class="avatar" id="userAvatar"></div>
      <span class="name" id="userName"></span>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn-save-top" onclick="saveAll()"><i class="fas fa-cloud-upload-alt"></i> Save All</button>
      <button class="btn-logout" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>
  <div id="crArea"></div>
  <div id="calArea" style="width:100%;display:flex;flex-direction:column;align-items:center"></div>
</div>

<script>
const STORE_ID='PAB',STORE_NAME='Pick A Bap';
const DEFAULT_API='https://script.google.com/macros/s/AKfycbwlvYuuX64za9sKfcJIgn1n2-6TQ0PW3wXON5eQJ88CUCyWfppfx0xmaWqDzzi5r2QG/exec';
const API_URL=(function(){try{const c=JSON.parse(localStorage.getItem('tbms_config'));return(c&&c.apiUrl)?c.apiUrl:DEFAULT_API;}catch(e){return DEFAULT_API;}})();
const $=id=>document.getElementById(id);
function toast(msg,type='info'){const t=document.createElement('div');t.className='toast '+type;t.innerHTML='<i class="fas fa-'+(type==='error'?'exclamation-circle':type==='success'?'check-circle':'info-circle')+'"></i> '+msg;$('toastBox').appendChild(t);setTimeout(()=>t.remove(),3000);}
function showLoad(t){$('loadingText').textContent=t;$('loading').classList.remove('hidden');}
function hideLoad(){$('loading').classList.add('hidden');}

async function apiGet(action){try{const r=await fetch(API_URL+'?action='+action,{redirect:'follow'});return await r.json();}catch(e){return null;}}
async function apiPost(data){try{const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(data),redirect:'follow'});return await r.json();}catch(e){return null;}}

let staff=[],attendance=[],timeChangeReqs=[],currentStaff=null;
let viewYear=new Date().getFullYear(), viewMonth=new Date().getMonth();
if(new Date().getDate()>=26){viewMonth++;if(viewMonth>11){viewMonth=0;viewYear++;}}
const STAFF_FIELDS=['id','storeId','name','nickName','clothSize','kioskPwd','dob','address','niNo','eVisa','mobile','startDate','leftDate','rate','sortCode','accountNo','email','memo','active'];
const ATT_FIELDS=['id','staffId','storeId','date','clockIn','clockOut','photoIn','photoOut','source'];
const TCR_FIELDS=['id','attendanceId','staffId','storeId','date','field','currentValue','requestedValue','reason','status','kioskVersion','createdAt','reviewedBy','reviewedAt'];
function nrmRow(fields,row){const m={};for(const k in row)m[k.replace(/[\s_\-]+/g,'').toLowerCase()]=row[k];const r={};for(const f of fields){const n=f.replace(/[\s_\-]+/g,'').toLowerCase();r[f]=m[n]!==undefined?m[n]:'';}return r;}
function genId(){return 'a'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);}

// ===== DATA LOADING =====
async function loadData(silent){
  if(!silent)showLoad('Loading data...');
  const result=await apiGet('getAll');
  if(result&&result.data&&!result.error){
    staff=(result.data.Staff||[]).map(r=>nrmRow(STAFF_FIELDS,r)).filter(s=>String(s.storeId)===STORE_ID&&(s.active===true||s.active==='true'||s.active==='TRUE'));
    attendance=(result.data.Attendance||[]).map(r=>nrmRow(ATT_FIELDS,r));
    timeChangeReqs=(result.data.TimeChangeReq||[]).map(r=>nrmRow(TCR_FIELDS,r));
    $('statusDot').className='status-dot on';$('statusText').textContent='Connected';
    if(!silent)hideLoad();return true;
  }
  $('statusDot').className='status-dot off';$('statusText').textContent='Offline';
  if(!silent){hideLoad();toast('Cannot connect to server','error');}
  return false;
}

// ===== STAFF GRID LOGIN =====
function isClockedIn(staffId){
  const today=new Date().toISOString().split('T')[0];
  return attendance.some(a=>String(a.staffId)===String(staffId)&&a.date===today&&a.clockIn&&!a.clockOut);
}

function showStaffGrid(){
  const now=new Date();
  const html=staff.map(s=>{
    const initials=(s.nickName||s.name||'?').charAt(0).toUpperCase();
    const ci=isClockedIn(s.id);
    return `<div class="staff-btn${ci?' clocked-in':''}" onclick="selectStaff('${s.id}')">
      <div class="avatar">${initials}<span class="status-dot"></span></div>
      <div class="name">${s.nickName||s.name}</div>
    </div>`;
  }).join('');
  $('staffGrid').innerHTML=`
    <div style="grid-column:1/-1;text-align:center">
      <div class="clock" id="clock">${now.toLocaleTimeString('en-GB')}</div>
      <div class="date-display">${now.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
    </div>
    ${html||'<p style="text-align:center;color:var(--text-light);grid-column:1/-1;padding:20px">No staff found</p>'}
    <div style="grid-column:1/-1;text-align:center;margin-top:8px"><button class="btn btn-primary" style="font-size:12px;padding:8px 16px" onclick="loadData().then(()=>showStaffGrid())"><i class="fas fa-sync"></i> Refresh</button></div>`;
  if(!window._clockInterval){
    window._clockInterval=setInterval(()=>{const el=$('clock');if(el)el.textContent=new Date().toLocaleTimeString('en-GB');},1000);
  }
}

// ===== PIN PAD =====
let pinTarget=null, pinValue='';
function selectStaff(id){
  pinTarget=staff.find(s=>s.id===id);
  if(!pinTarget)return;
  pinValue='';
  const initials=(pinTarget.nickName||pinTarget.name||'?').slice(0,2).toUpperCase();
  $('pinAvatar').textContent=initials;
  $('pinName').textContent=pinTarget.nickName||pinTarget.name;
  $('pinError').textContent='';
  renderPinDots();
  $('loginScreen').style.display='none';
  $('pinScreen').style.display='flex';
}
function renderPinDots(){
  let dots='';
  for(let i=0;i<Math.max(pinValue.length,4);i++){
    dots+=`<div class="pin-dot${i<pinValue.length?' filled':''}"></div>`;
  }
  if(pinValue.length<4){dots='';for(let i=0;i<4;i++)dots+=`<div class="pin-dot${i<pinValue.length?' filled':''}"></div>`;}
  $('pinDots').innerHTML=dots;
}
function pinPress(n){
  if(pinValue.length>=10)return;
  pinValue+=n;
  $('pinError').textContent='';
  renderPinDots();
}
function pinClear(){
  pinValue='';
  $('pinError').textContent='';
  renderPinDots();
}
function pinBack(){
  pinTarget=null;pinValue='';
  $('pinScreen').style.display='none';
  $('loginScreen').style.display='flex';
}
function pinEnter(){
  if(!pinTarget)return;
  if(!pinValue){$('pinError').textContent='Enter your password';return;}
  if(String(pinTarget.kioskPwd)!==String(pinValue)){
    $('pinError').textContent='Incorrect password';
    pinValue='';renderPinDots();
    return;
  }
  // Login success
  currentStaff=pinTarget;
  const initials=(currentStaff.nickName||currentStaff.name||'?').slice(0,2).toUpperCase();
  $('userAvatar').textContent=initials;
  $('userName').textContent=currentStaff.nickName||currentStaff.name;
  $('pinScreen').style.display='none';
  $('mainWrap').style.display='flex';
  renderChangeRequests();
  renderCalendar();
}

function doLogout(){
  currentStaff=null;pinTarget=null;pinValue='';
  $('mainWrap').style.display='none';
  $('loginScreen').style.display='flex';
}

// ===== CHANGE REQUESTS DISPLAY =====
function getAckedCrIds(){
  try{return JSON.parse(localStorage.getItem('tbms_cr_acked_'+STORE_ID)||'[]');}catch(e){return [];}
}
function ackCr(id){
  const acked=getAckedCrIds();
  if(!acked.includes(id))acked.push(id);
  localStorage.setItem('tbms_cr_acked_'+STORE_ID,JSON.stringify(acked));
  renderChangeRequests();
}
function renderChangeRequests(){
  if(!currentStaff){$('crArea').innerHTML='';return;}
  const acked=getAckedCrIds();
  const myReqs=timeChangeReqs.filter(r=>String(r.staffId)===String(currentStaff.id)&&String(r.storeId)===STORE_ID)
    .filter(r=>r.status==='pending'||!acked.includes(r.id))
    .sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||''));
  if(myReqs.length===0){$('crArea').innerHTML='';return;}
  const pendCount=myReqs.filter(r=>r.status==='pending').length;
  let html=`<div class="cr-card"><h3><i class="fas fa-exchange-alt" style="color:var(--warning);margin-right:6px"></i>My Change Requests ${pendCount>0?`<span style="background:#fff3cd;color:#856404;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:4px">${pendCount} pending</span>`:''}</h3>`;
  myReqs.slice(0,10).forEach(r=>{
    let badge='',ackBtn='';
    if(r.status==='pending')badge='<span class="cr-badge pending">Pending</span>';
    else if(r.status==='approved'){badge='<span class="cr-badge approved">Approved</span>';ackBtn=`<button class="cr-ack-btn" onclick="event.stopPropagation();ackCr('${r.id}')"><i class="fas fa-check"></i> 확인</button>`;}
    else if(r.status==='rejected'){badge='<span class="cr-badge rejected">Rejected</span>';ackBtn=`<button class="cr-ack-btn rej" onclick="event.stopPropagation();ackCr('${r.id}')"><i class="fas fa-check"></i> 확인</button>`;}
    html+=`<div class="cr-item">
      <div style="flex:1"><strong>${r.date||'—'}</strong> · ${r.field||''}: ${r.currentValue||'—'} → <span style="color:var(--primary);font-weight:700">${r.requestedValue||'—'}</span></div>
      <div style="display:flex;align-items:center;gap:6px">${badge}${ackBtn}</div>
    </div>`;
  });
  if(myReqs.length>10)html+=`<div style="text-align:center;font-size:11px;color:var(--text-light);padding:6px">+${myReqs.length-10} more</div>`;
  html+='</div>';
  $('crArea').innerHTML=html;
}

// ===== CALENDAR =====
function getPeriodDates(){
  const prevM=viewMonth===0?11:viewMonth-1;
  const prevY=viewMonth===0?viewYear-1:viewYear;
  const startDate=new Date(prevY,prevM,26);
  const endDate=new Date(viewYear,viewMonth,25);
  const dates=[];
  for(let d=new Date(startDate);d<=endDate;d.setDate(d.getDate()+1)){dates.push(new Date(d));}
  return dates;
}
function fmtDate(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function periodLabel(){
  const mShort=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const prevM=viewMonth===0?11:viewMonth-1;
  return '26 '+mShort[prevM]+' — 25 '+mShort[viewMonth]+' '+viewYear;
}

function renderCalendar(){
  if(!currentStaff)return;
  const s=currentStaff;
  const dayNames=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const dates=getPeriodDates();
  const today=new Date();const todayStr=fmtDate(today);
  const dateSet=new Set(dates.map(d=>fmtDate(d)));
  const myAtt=attendance.filter(a=>String(a.staffId)===String(s.id)&&dateSet.has(a.date));
  let rows='',totalHours=0,totalDays=0,lastMonth=-1;
  const mNames=['January','February','March','April','May','June','July','August','September','October','November','December'];
  dates.forEach(dateObj=>{
    const dow=dateObj.getDay();
    const dateStr=fmtDate(dateObj);
    const dayLabel=dayNames[dow===0?6:dow-1];
    const isToday=dateStr===todayStr;
    const dm=dateObj.getMonth();
    if(dm!==lastMonth){
      lastMonth=dm;
      rows+=`<tr><td colspan="5" style="background:var(--primary);color:#fff;font-weight:700;font-size:11px;padding:4px 8px;border:none;text-align:left">
        <i class="fas fa-calendar" style="margin-right:4px"></i>${mNames[dm]} ${dateObj.getFullYear()}</td></tr>`;
    }
    const rec=myAtt.find(a=>a.date===dateStr);
    const clockIn=rec?rec.clockIn:'';
    const clockOut=rec?rec.clockOut:'';
    const hours=calcHours(clockIn,clockOut);
    if(hours>0){totalHours+=hours;totalDays++;}
    const rowClass=isToday?'today':dow===6?'sat':dow===0?'sun':'';
    const dayClass=dow===0?'day-cell day-sun':dow===6?'day-cell day-sat':'day-cell';
    rows+=`<tr class="${rowClass}">
      <td class="date-cell">${dateObj.getDate()}</td>
      <td class="${dayClass}">${dayLabel}</td>
      <td>${timeSelHtml('in',dateStr,clockIn)}</td>
      <td>${timeSelHtml('out',dateStr,clockOut)}</td>
      <td class="hour-cell ${hours===0?'zero':''}" id="hr_${dateStr}">${hours>0?hours.toFixed(1):'—'}</td>
    </tr>`;
  });
  $('calArea').innerHTML=`
    <div class="card">
      <div class="card-header">
        <h2>${periodLabel()}</h2>
        <div class="month-nav">
          <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
          <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table class="time-table">
          <thead><tr><th>Date</th><th>Day</th><th>IN</th><th>OUT</th><th>Hours</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div class="summary-bar">
        <div><div class="label">Total Hours</div><div class="total" id="totalHours">${totalHours.toFixed(1)} hrs</div></div>
        <div style="text-align:right"><div class="label">Days Worked</div><div class="total" id="totalDays">${totalDays}</div></div>
      </div>
      <div style="display:flex;justify-content:center;margin-top:14px">
        <button class="btn btn-save" onclick="saveAll()"><i class="fas fa-cloud-upload-alt"></i> Save All</button>
      </div>
    </div>`;
}

// ===== TIME SELECT HELPERS =====
function timeSelHtml(prefix,ds,val){
  const [vh,vm]=val?val.split(':'):['','00'];
  const rvm=vm?String(Math.round(parseInt(vm)/10)*10).padStart(2,'0'):'00';
  let hOpts='<option value="">--</option>';
  for(let i=0;i<24;i++){const hh=String(i).padStart(2,'0');hOpts+=`<option value="${hh}"${hh===vh?' selected':''}>${hh}</option>`;}
  const mins=['00','10','20','30','40','50'];
  let mOpts='';mins.forEach(mm=>{mOpts+=`<option value="${mm}"${mm===rvm?' selected':''}>${mm}</option>`;});
  const fc=vh?'filled':'';
  return `<span class="time-wrap"><select id="${prefix}H_${ds}" onchange="calcRow('${ds}')" class="time-sel ${fc}">${hOpts}</select><span class="colon">:</span><select id="${prefix}M_${ds}" onchange="calcRow('${ds}')" class="time-sel ${fc}">${mOpts}</select></span>`;
}
function getTimeVal(prefix,ds){
  const h=$(prefix+'H_'+ds),m=$(prefix+'M_'+ds);
  if(!h||!m||h.value==='')return '';
  return h.value+':'+m.value;
}
function calcHours(inTime,outTime){
  if(!inTime||!outTime)return 0;
  const [ih,im]=inTime.split(':').map(Number);
  const [oh,om]=outTime.split(':').map(Number);
  let mins=(oh*60+om)-(ih*60+im);
  if(mins<0)mins+=24*60;
  return Math.round(mins/6)/10;
}
function calcRow(dateStr){
  const inVal=getTimeVal('in',dateStr);
  const outVal=getTimeVal('out',dateStr);
  const hrs=calcHours(inVal,outVal);
  const hrEl=$('hr_'+dateStr);
  if(hrEl){hrEl.textContent=hrs>0?hrs.toFixed(1):'—';hrEl.className='hour-cell'+(hrs===0?' zero':'');}
  ['in','out'].forEach(p=>{
    const v=p==='in'?inVal:outVal;
    const hEl=$(p+'H_'+dateStr),mEl=$(p+'M_'+dateStr);
    if(hEl){hEl.className='time-sel'+(v?' filled':'');}
    if(mEl){mEl.className='time-sel'+(v?' filled':'');}
  });
  recalcTotals();
}
function recalcTotals(){
  const dates=getPeriodDates();
  let totalHrs=0,totalDays=0;
  dates.forEach(d=>{
    const dateStr=fmtDate(d);
    const inVal=getTimeVal('in',dateStr);
    const outVal=getTimeVal('out',dateStr);
    const hrs=calcHours(inVal,outVal);
    if(hrs>0){totalHrs+=hrs;totalDays++;}
  });
  const thEl=$('totalHours');if(thEl)thEl.textContent=totalHrs.toFixed(1)+' hrs';
  const tdEl=$('totalDays');if(tdEl)tdEl.textContent=totalDays;
}

// ===== SAVE WITH EDIT LOG + CHANGE REQUEST =====
async function saveAll(){
  if(!currentStaff)return;
  const dates=getPeriodDates();
  const rows=[];
  const editLogs=[];
  const changeReqs=[];
  const today=new Date();
  const yesterdayStr=fmtDate(new Date(today.getFullYear(),today.getMonth(),today.getDate()-1));
  dates.forEach(d=>{
    const dateStr=fmtDate(d);
    const inVal=getTimeVal('in',dateStr);
    const outVal=getTimeVal('out',dateStr);
    if(!inVal&&!outVal)return;
    const existing=attendance.find(a=>String(a.staffId)===String(currentStaff.id)&&a.date===dateStr);
    if(existing && dateStr<yesterdayStr){
      const inChanged=existing.clockIn!==inVal;
      const outChanged=existing.clockOut!==outVal;
      if(inChanged)changeReqs.push({attendanceId:existing.id,staffId:currentStaff.id,storeId:STORE_ID,date:dateStr,field:'clockIn',currentValue:existing.clockIn||'',requestedValue:inVal,kioskVersion:'kiosk3'});
      if(outChanged)changeReqs.push({attendanceId:existing.id,staffId:currentStaff.id,storeId:STORE_ID,date:dateStr,field:'clockOut',currentValue:existing.clockOut||'',requestedValue:outVal,kioskVersion:'kiosk3'});
      return;
    }
    const row={
      id:existing?existing.id:genId(),
      staffId:currentStaff.id,
      storeId:STORE_ID,
      date:dateStr,
      clockIn:inVal,
      clockOut:outVal,
      photoIn:'',
      photoOut:'',
      source:'kiosk3'
    };
    rows.push(row);
    if(existing){
      if(existing.clockIn!==inVal)editLogs.push({attendanceId:row.id,staffId:currentStaff.id,storeId:STORE_ID,date:dateStr,fieldChanged:'clockIn',oldValue:existing.clockIn||'',newValue:inVal,kioskVersion:'kiosk3'});
      if(existing.clockOut!==outVal)editLogs.push({attendanceId:row.id,staffId:currentStaff.id,storeId:STORE_ID,date:dateStr,fieldChanged:'clockOut',oldValue:existing.clockOut||'',newValue:outVal,kioskVersion:'kiosk3'});
      existing.clockIn=inVal;existing.clockOut=outVal;existing.source='kiosk3';
    }else{
      if(inVal)editLogs.push({attendanceId:row.id,staffId:currentStaff.id,storeId:STORE_ID,date:dateStr,fieldChanged:'clockIn',oldValue:'',newValue:inVal,kioskVersion:'kiosk3'});
      if(outVal)editLogs.push({attendanceId:row.id,staffId:currentStaff.id,storeId:STORE_ID,date:dateStr,fieldChanged:'clockOut',oldValue:'',newValue:outVal,kioskVersion:'kiosk3'});
      attendance.push(row);
    }
  });
  if(rows.length===0&&changeReqs.length===0){toast('No hours entered','info');return;}
  if(changeReqs.length>0){
    const reason=prompt('You are modifying times for past dates ('+changeReqs.length+' change(s)).\nPlease enter a reason:');
    if(!reason){toast('Change request cancelled','info');return;}
    toast('Submitting '+changeReqs.length+' change request(s)...','info');
    let crOk=true;
    for(const cr of changeReqs){
      const res=await apiPost({action:'timeChangeReq',...cr,reason:reason});
      if(res&&!res.error){timeChangeReqs.push({...cr,reason:reason,status:'pending',createdAt:new Date().toISOString(),reviewedBy:'',reviewedAt:''});}
      else crOk=false;
    }
    if(crOk)toast(changeReqs.length+' change request(s) submitted for approval','success');
    else toast('Some change requests failed to submit','error');
    renderChangeRequests();
  }
  if(rows.length>0){
    toast('Saving '+rows.length+' records...','info');
    let ok=true;
    const attPromises=rows.map(r=>apiPost({action:'upsert',sheet:'Attendance',row:r}));
    const attResults=await Promise.all(attPromises);
    attResults.forEach(r=>{if(!r||r.error)ok=false;});
    if(editLogs.length>0){editLogs.forEach(log=>apiPost({action:'editLog',...log}));}
    if(ok){
      $('statusDot').className='status-dot on';
      toast('Saved successfully!','success');
    }else{
      $('statusDot').className='status-dot off';
      toast('Some records failed to save','error');
    }
  }
}

function changeMonth(dir){
  viewMonth+=dir;
  if(viewMonth>11){viewMonth=0;viewYear++;}
  if(viewMonth<0){viewMonth=11;viewYear--;}
  renderCalendar();
}

// ===== INIT =====
async function init(){
  const ok=await loadData();
  if(ok){
    showStaffGrid();
    hideLoad();
  }else{
    hideLoad();
    $('loginScreen').innerHTML='<div style="text-align:center;padding:40px"><p style="color:var(--danger);font-size:18px;margin-bottom:16px"><i class="fas fa-exclamation-triangle"></i> Connection Failed</p><button class="btn btn-primary" onclick="location.reload()"><i class="fas fa-redo"></i> Retry</button></div>';
  }
  setInterval(async()=>{if(!currentStaff){await loadData(true);showStaffGrid();}},15*60*1000);
}
// ===== Fullscreen Mode =====
function goFullscreen(){
  const el=document.documentElement;
  if(el.requestFullscreen)el.requestFullscreen();
  else if(el.webkitRequestFullscreen)el.webkitRequestFullscreen();
  else if(el.msRequestFullscreen)el.msRequestFullscreen();
  const ov=document.getElementById('fsOverlay');if(ov)ov.remove();
}
function exitFsHandler(){
  if(!document.fullscreenElement&&!document.webkitFullscreenElement){
    if(!document.getElementById('fsOverlay'))showFsOverlay();
  }
}
function showFsOverlay(){
  const ov=document.createElement('div');ov.className='fs-overlay';ov.id='fsOverlay';
  ov.innerHTML='<div class="fs-icon"><i class="fas fa-expand"></i></div><h2>Tap to Start</h2><p>Full screen kiosk mode</p>';
  ov.addEventListener('click',goFullscreen);
  document.body.appendChild(ov);
}
document.addEventListener('fullscreenchange',exitFsHandler);
document.addEventListener('webkitfullscreenchange',exitFsHandler);
if(!window.matchMedia('(display-mode: standalone)').matches&&!window.matchMedia('(display-mode: fullscreen)').matches){
  showFsOverlay();
}

init();
</script>
</body>
</html>
